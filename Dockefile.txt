# Use NVIDIA CUDA runtime base (Ubuntu 22.04) â€” suitable for GPU workloads
FROM nvidia/cuda:11.8.0-cudnn8-runtime-ubuntu22.04


# metadata
LABEL maintainer="your-name <you@example.com>"


# Set working directory
WORKDIR /app


# Install system deps
ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update && apt-get install -y --no-install-recommends \
ca-certificates curl wget git bzip2 build-essential && \
rm -rf /var/lib/apt/lists/*


# Install Miniconda (quiet)
ENV CONDA_DIR=/opt/conda
ENV PATH=${CONDA_DIR}/bin:$PATH
RUN wget --quiet https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O /tmp/miniconda.sh && \
bash /tmp/miniconda.sh -b -p ${CONDA_DIR} && \
rm /tmp/miniconda.sh && \
${CONDA_DIR}/bin/conda init bash && \
${CONDA_DIR}/bin/conda config --set always_yes yes --set changeps1 no && \
${CONDA_DIR}/bin/conda clean -afy


# Copy environment.yml early to leverage Docker cache
COPY environment.yml /app/environment.yml


# Create conda environment from environment.yml
# Note: the environment.yml should include the appropriate pytorch/cuda packages, or they will be installed here
# If environment.yml sets `name: dacl_env` that name will be used. Otherwise we create a env called `dacl_env`.
RUN set -eux; \
ENV_NAME=$(grep -E '^name:[[:space:]]*' environment.yml || true) || true; \
if grep -q '^name:' environment.yml; then \
# create using the name present in environment.yml
${CONDA_DIR}/bin/conda env create -f environment.yml; \
else \
# fallback: create environment named dacl_env
${CONDA_DIR}/bin/conda env create -f environment.yml -n dacl_env; \
fi && \
${CONDA_DIR}/bin/conda clean -afy


# Ensure conda environment is available in non-interactive shells
SHELL ["/bin/bash", "-lc"]


# Copy the rest of the repository
COPY . /app


# Ensure training outputs directory exists
RUN mkdir -p /app/outputs


# Make sure python outputs are unbuffered (helpful for logs)
ENV PYTHONUNBUFFERED=1


# Default entrypoint will run train.py inside the conda env
# If the environment.yml contains a name, replace 'dacl_env' below with that name.
ENTRYPOINT ["/opt/conda/bin/conda", "run", "-n", "dacl_env", "--no-capture-output", "python", "train.py"]


# Default arguments can be overridden by docker run or docker compose command.
CMD ["--help"]